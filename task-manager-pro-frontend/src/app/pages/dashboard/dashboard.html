<div class="page">
  <div class="topbar">
    <h1>Minhas Tasks</h1>
    <button class="btn ghost" type="button" (click)="logout()">Sair</button>
  </div>

  <!-- SEARCH + HISTORY -->
  <div class="card">
    <label>Buscar (Redis cache)</label>

    <form [formGroup]="searchForm" (submit)="$event.preventDefault()">
      <div class="row">
        <div class="col">
          <input
            type="text"
            formControlName="q"
            placeholder="Ex: estudar go, academia, mercado..."
          />
        </div>

        <div class="col right">
          <button class="btn ghost" type="button" (click)="clearSearch()">Limpar</button>
          <button class="btn" type="button" (click)="loadTasks()">Atualizar</button>
        </div>
      </div>
    </form>

    <div *ngIf="history.length > 0" style="margin-top: 14px">
      <div style="opacity: 0.9; margin-bottom: 10px">Últimas buscas</div>

      <div style="display: flex; flex-wrap: wrap; gap: 8px">
        <button
          class="btn small ghost"
          *ngFor="let h of history"
          type="button"
          (click)="clickHistory(h)"
          title="Clique para buscar"
        >
          {{ h }}
        </button>
      </div>
    </div>

    <p class="error" *ngIf="errorMsg">{{ errorMsg }}</p>
  </div>

  <!-- CREATE -->
  <div class="card">
    <h2>Criar task</h2>

    <form class="form" [formGroup]="createForm" (ngSubmit)="onCreate()">
      <label>Título</label>
      <input formControlName="title" placeholder="Ex: Estudar Go" />

      <label>Descrição</label>
      <input formControlName="description" placeholder="Opcional" />

      <!-- IA Actions (Create) -->
      <div class="ai-actions" style="margin-top: 10px">
        <button
          class="btn small ghost"
          type="button"
          (click)="onSuggestTitle('create')"
          [disabled]="aiLoading"
        >
          ✨ Sugerir título
        </button>

        <button
          class="btn small ghost"
          type="button"
          (click)="onImproveDescription('create')"
          [disabled]="aiLoading"
        >
          ✨ Melhorar descrição
        </button>

        <span *ngIf="aiLoading" style="opacity: 0.85">Gerando...</span>
        <span *ngIf="aiError" style="color: #ff6b6b">{{ aiError }}</span>
      </div>

      <div class="row">
        <div class="col">
          <label>Status</label>
          <select formControlName="status">
            <option value="TODO">TODO</option>
            <option value="DOING">DOING</option>
            <option value="DONE">DONE</option>
          </select>
        </div>

        <div class="col">
          <label>Prioridade</label>
          <select formControlName="priority">
            <option value="LOW">LOW</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HIGH">HIGH</option>
          </select>
        </div>

        <div class="col right">
          <button class="btn" type="submit" [disabled]="loading || createForm.invalid">
            {{ loading ? 'Criando...' : 'Criar' }}
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- LIST -->
  <div class="card">
    <div class="listHeader">
      <h2>Lista</h2>
      <button class="btn ghost" type="button" (click)="loadTasks()">Atualizar</button>
    </div>

    <p *ngIf="loading">Carregando...</p>

    <div class="task" *ngFor="let t of tasks">
      <div class="taskTop">
        <strong>{{ t.title }}</strong>

        <div class="actions" *ngIf="editingId !== t.id">
          <button class="btn small" type="button" (click)="startEdit(t)">Editar</button>
          <button class="btn small danger" type="button" (click)="deleteTask(t.id)">Deletar</button>
        </div>
      </div>

      <ng-container *ngIf="editingId !== t.id; else editTpl">
        <div class="badges">
          <span class="badge">{{ t.status }}</span>
          <span class="badge">{{ t.priority }}</span>
        </div>

        <p class="desc" *ngIf="t.description">{{ t.description }}</p>
      </ng-container>

      <ng-template #editTpl>
        <form class="editForm" [formGroup]="editForm" (ngSubmit)="saveEdit(t.id)">
          <label>Título</label>
          <input formControlName="title" />

          <label>Descrição</label>
          <input formControlName="description" />

          <!-- IA Actions (Edit) -->
          <div class="ai-actions" style="margin-top: 10px">
            <button
              class="btn small ghost"
              type="button"
              (click)="onSuggestTitle('edit')"
              [disabled]="aiLoading"
            >
              ✨ Sugerir título
            </button>

            <button
              class="btn small ghost"
              type="button"
              (click)="onImproveDescription('edit')"
              [disabled]="aiLoading"
            >
              ✨ Melhorar descrição
            </button>

            <span *ngIf="aiLoading" style="opacity: 0.85">Gerando...</span>
            <span *ngIf="aiError" style="color: #ff6b6b">{{ aiError }}</span>
          </div>

          <div class="row">
            <div class="col">
              <label>Status</label>
              <select formControlName="status">
                <option value="TODO">TODO</option>
                <option value="DOING">DOING</option>
                <option value="DONE">DONE</option>
              </select>
            </div>

            <div class="col">
              <label>Prioridade</label>
              <select formControlName="priority">
                <option value="LOW">LOW</option>
                <option value="MEDIUM">MEDIUM</option>
                <option value="HIGH">HIGH</option>
              </select>
            </div>

            <div class="col right">
              <button class="btn small" type="submit" [disabled]="loading || editForm.invalid">
                Salvar
              </button>
              <button class="btn small ghost" type="button" (click)="cancelEdit()">Cancelar</button>
            </div>
          </div>
        </form>
      </ng-template>
    </div>

    <p *ngIf="!loading && tasks.length === 0">Nenhuma task encontrada.</p>
  </div>

  <!-- ===== IA MODAL (shared) ===== -->
  <div class="ai-modal-backdrop" *ngIf="aiModal">
    <div class="ai-modal">
      <div
        class="ai-modal-header"
        style="display: flex; justify-content: space-between; align-items: center"
      >
        <h3 style="margin: 0" *ngIf="aiModal === 'titles'">Escolha um título</h3>
        <h3 style="margin: 0" *ngIf="aiModal === 'improve'">Descrição melhorada</h3>

        <button type="button" class="btn small ghost" (click)="closeAiModal()">✕</button>
      </div>

      <div class="ai-modal-body" style="margin-top: 12px">
        <!-- TITLES -->
        <div *ngIf="aiModal === 'titles'">
          <div
            class="option"
            *ngFor="let t of aiTitleOptions"
            style="
              display: flex;
              justify-content: space-between;
              gap: 12px;
              padding: 10px;
              border: 1px solid rgba(255, 255, 255, 0.12);
              border-radius: 10px;
              margin-bottom: 10px;
            "
          >
            <div class="text" style="flex: 1">{{ t }}</div>
            <button class="btn small" type="button" (click)="applyTitle(t)">Aplicar</button>
          </div>
        </div>

        <!-- IMPROVE -->
        <div *ngIf="aiModal === 'improve'">
          <p style="opacity: 0.95; line-height: 1.4; white-space: pre-wrap">
            {{ aiImprovedText }}
          </p>

          <ul style="margin-top: 10px">
            <li *ngFor="let b of aiImprovedBullets">{{ b }}</li>
          </ul>

          <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap">
            <button class="btn" type="button" (click)="applyImprovedDescription()">
              Aplicar descrição
            </button>
            <button class="btn ghost" type="button" (click)="closeAiModal()">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
